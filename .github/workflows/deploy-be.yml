name: backend deployment
on:
  push:
    branches:
      - main
    paths:
      - "backend/**"
      - ".github/workflows/deploy-be.yml"
jobs:
  backend-deployment:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@main
      - name: setup go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"
      - name: display go version
        run: go version
      - name: install dependencies
        run: go get .
      # - name: test apps
      #   run: go test
      - name: install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
      - name: build container image
        run: docker build -t ${{ secrets.REGISTRY_NAME }}/
      - name: login to digital ocean container registry
        run: doctl registry login --expire-seconds 2400
      - name: push image to registry
        run: docker push ${{ secrets.REGISTRY_NAME }}/commerce:$(echo $GITHUB_SHA | head -c7)
      - name: exec remote ssh
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.PRIVATE_KEY }}
          passphrase: ${{ secrets.PASSPHRASE }}
          port: 22
          script: |
            cd commerce/backend/
            docker compose down
            git pull origin main
            docker compose up --build --detach commerce_api